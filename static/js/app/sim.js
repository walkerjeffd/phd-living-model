define(["underscore","d3"],function(e,t){var n=function(){var e=[],n=function(e,t){var n=e/180*Math.PI,r=1+.033*Math.cos(2*Math.PI*t/365),i=.4093*Math.sin(2*Math.PI*t/365-1.405),s=Math.acos(-Math.tan(n)*Math.tan(i)),o=24*s/Math.PI,u=15.392*r*(Math.sin(n)*s*Math.sin(i)+Math.cos(n)*Math.cos(i)*Math.sin(s)),a=u*.03937;return a},r=function(e,t,n){return t>0?.0023*e*(n+17.8)*Math.sqrt(t):0},i=function(i,s){console.log("SimModel: set input"),e.length=0;for(var o=0,u=i.length;o<u;o++){var a={};a.Date=i[o].Date,a.Tmin=i[o].Tmin_degC,a.Tmax=i[o].Tmax_degC,a.P=i[o].Precip_in,a.obsQ=i[o].Flow_in,a.Jday=t.time.dayOfYear(a.Date)+1,a.Trng=a.Tmax-a.Tmin,a.Tavg=(a.Tmax+a.Tmin)/2,a.SR=n(s,a.Jday),a.PET=r(a.SR,a.Trng,a.Tavg),e.push(a)}},s=function(t){var n,r,i,s,o,u,a,f,l,c,h=t.get("param_a"),p=t.get("param_b"),d=t.get("param_c"),v=t.get("param_d"),m=t.get("watershed").latitude;for(var g=0,y=e.length;g<y;g++)g===0&&(i=t.get("param_S0"),a=t.get("param_G0")),n=i+e[g].P,r=(n+p)/(2*h)-Math.sqrt(Math.pow((n+p)/(2*h),2)-n*p/h),i=r*Math.exp(-e[g].PET/p),s=r-i,o=d*(n-r),u=(1-d)*(n-r),c=o+a,a=c/(1+v),f=v*c/(1+v),l=Math.max(u+f,.001),e[g].W=n,e[g].Y=r,e[g].S=i,e[g].ET=s,e[g].GR=o,e[g].DR=u,e[g].WGW=c,e[g].G=a,e[g].GD=f,e[g].Q=l,e[g].resQ=e[g].obsQ-l};return{run:s,output:e,setInput:i}};return n});